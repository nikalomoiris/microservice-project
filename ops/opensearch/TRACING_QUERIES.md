# OpenSearch Queries for Distributed Tracing

This document provides useful OpenSearch queries for analyzing distributed traces stored by Zipkin.

## Prerequisites

- Zipkin configured with OpenSearch backend
- Index template `zipkin-template` applied
- Traces being generated by services

## Index Pattern

Zipkin creates indices with the pattern: `zipkin-span-YYYY-MM-DD`

Example: `zipkin-span-2025-11-16`

---

## Common Queries

### 1. Find All Traces for a Specific Service

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "size": 10,
  "query": {
    "term": {
      "localEndpoint.serviceName": "order-service"
    }
  },
  "sort": [
    { "timestamp": { "order": "desc" } }
  ]
}'
```

### 2. Find Slow Traces (Duration > 1 Second)

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "query": {
    "range": {
      "duration": {
        "gte": 1000000
      }
    }
  },
  "sort": [
    { "duration": { "order": "desc" } }
  ]
}'
```

### 3. Find Traces by TraceId

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "query": {
    "term": {
      "traceId": "YOUR_TRACE_ID_HERE"
    }
  }
}'
```

### 4. Find Traces with Errors (HTTP 5xx)

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "query": {
    "wildcard": {
      "tags.http.status_code": "5*"
    }
  }
}'
```

### 5. Find Traces for Specific Endpoint

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "query": {
    "bool": {
      "must": [
        { "term": { "tags.http.method": "POST" } },
        { "wildcard": { "tags.http.path": "/api/orders*" } }
      ]
    }
  }
}'
```

### 6. Count Traces by Service

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "size": 0,
  "aggs": {
    "services": {
      "terms": {
        "field": "localEndpoint.serviceName",
        "size": 20
      }
    }
  }
}'
```

### 7. Average Duration by Service

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "size": 0,
  "aggs": {
    "services": {
      "terms": {
        "field": "localEndpoint.serviceName"
      },
      "aggs": {
        "avg_duration": {
          "avg": {
            "field": "duration"
          }
        }
      }
    }
  }
}'
```

### 8. Find RabbitMQ Message Traces

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "query": {
    "bool": {
      "should": [
        { "wildcard": { "name": "*send*" } },
        { "wildcard": { "name": "*receive*" } }
      ]
    }
  }
}'
```

---

## Trace-Log Correlation

### Find Logs for a Specific Trace

Once you have a `traceId` from Zipkin, correlate with structured logs:

```bash
curl http://localhost:9200/service-logs*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "query": {
    "term": {
      "traceId": "80f198ee56343ba864fe8b2a57d3eff7"
    }
  },
  "sort": [
    { "timestamp": { "order": "asc" } }
  ]
}'
```

### Combined Query: Slow Traces with Their Logs

```bash
# Step 1: Find slow traces
TRACE_ID=$(curl -s http://localhost:9200/zipkin*/_search -H 'Content-Type: application/json' -d '
{
  "size": 1,
  "query": {
    "range": {
      "duration": {
        "gte": 500000
      }
    }
  }
}' | grep -o '"traceId":"[^"]*"' | head -1 | cut -d'"' -f4)

# Step 2: Get all logs for that trace
curl http://localhost:9200/service-logs*/_search?pretty -H 'Content-Type: application/json' -d "
{
  \"query\": {
    \"term\": {
      \"traceId\": \"$TRACE_ID\"
    }
  }
}"
```

---

## Time-Based Queries

### Traces in Last Hour

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "query": {
    "range": {
      "timestamp": {
        "gte": "now-1h"
      }
    }
  }
}'
```

### Traces in Specific Time Range

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "query": {
    "range": {
      "timestamp": {
        "gte": "2025-11-16T10:00:00",
        "lte": "2025-11-16T11:00:00",
        "format": "strict_date_optional_time"
      }
    }
  }
}'
```

---

## Aggregations

### Error Rate by Service

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "size": 0,
  "aggs": {
    "services": {
      "terms": {
        "field": "localEndpoint.serviceName"
      },
      "aggs": {
        "error_rate": {
          "filters": {
            "filters": {
              "errors": {
                "wildcard": { "tags.http.status_code": "5*" }
              }
            }
          }
        }
      }
    }
  }
}'
```

### 95th Percentile Duration by Endpoint

```bash
curl http://localhost:9200/zipkin*/_search?pretty -H 'Content-Type: application/json' -d '
{
  "size": 0,
  "aggs": {
    "endpoints": {
      "terms": {
        "field": "name"
      },
      "aggs": {
        "p95_duration": {
          "percentiles": {
            "field": "duration",
            "percents": [95]
          }
        }
      }
    }
  }
}'
```

---

## Useful Dashboards

Create these visualizations in OpenSearch Dashboards:

1. **Service Map**: Visualize service dependencies from parent-child span relationships
2. **Latency Heatmap**: Show duration distribution over time
3. **Error Rate Timeline**: Track HTTP errors by service
4. **Trace Volume**: Count of traces per service over time
5. **Slow Transactions**: Table of slowest traces with drill-down

---

## Index Management

### Check Index Size

```bash
curl http://localhost:9200/_cat/indices/zipkin*?v&s=index
```

### Delete Old Traces (Older than 7 Days)

```bash
curl -X DELETE "http://localhost:9200/zipkin-span-$(date -d '7 days ago' +%Y-%m-%d)"
```

### Create Index Lifecycle Policy (ILM)

```bash
curl -X PUT http://localhost:9200/_plugins/_ism/policies/zipkin-retention -H 'Content-Type: application/json' -d '
{
  "policy": {
    "description": "Zipkin trace retention policy",
    "default_state": "hot",
    "states": [
      {
        "name": "hot",
        "transitions": [
          {
            "state_name": "delete",
            "conditions": {
              "min_index_age": "7d"
            }
          }
        ]
      },
      {
        "name": "delete",
        "actions": [
          {
            "delete": {}
          }
        ]
      }
    ]
  }
}'
```

---

## Performance Tips

1. **Use index patterns wisely**: Query specific date indices when possible
   - Good: `zipkin-span-2025-11-16/_search`
   - Avoid: `zipkin*/_search` for large date ranges

2. **Limit result size**: Use `size` parameter to avoid large result sets
   - Default: `"size": 10`
   - Max recommended: `"size": 100`

3. **Use filters over queries**: Filters are cached and faster
   ```json
   {
     "query": {
       "bool": {
         "filter": [
           { "term": { "localEndpoint.serviceName": "order-service" } }
         ]
       }
     }
   }
   ```

4. **Enable query caching**: Already configured in index template

5. **Use scroll API for large exports**:
   ```bash
   curl 'http://localhost:9200/zipkin*/_search?scroll=1m&size=100'
   ```
